#!/bin/bash
# Wrapper для запуска bw-secrets-daemon через launchd
# Получает BW_SESSION из macOS Keychain

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Загрузить .env (BW_SERVER)
if [ -f "$PROJECT_DIR/.env" ]; then
    export $(grep -v '^#' "$PROJECT_DIR/.env" | xargs)
fi

# Настроить сервер Bitwarden (если указан)
if [ -n "${BW_SERVER}" ]; then
    CURRENT_SERVER=$(bw config server 2>/dev/null)
    if [ "${CURRENT_SERVER}" != "${BW_SERVER}" ]; then
        echo "Configuring server: ${BW_SERVER}" >&2
        # Logout если залогинен на другом сервере
        bw logout 2>/dev/null
        bw config server "${BW_SERVER}"
    fi
fi

# Получить BW_SESSION из Keychain
BW_SESSION=$(security find-generic-password \
    -a "${USER}" \
    -s "bw-secrets-session" \
    -w 2>/dev/null)

if [ -z "${BW_SESSION}" ]; then
    echo "ERROR: BW_SESSION not found in Keychain" >&2
    echo "Run: bw-unlock" >&2
    exit 1
fi

# Экспортировать и запустить демон
export BW_SESSION
cd "$PROJECT_DIR"
exec .venv/bin/bw-secrets-daemon
